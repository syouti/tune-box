

<div class="collection-container">
  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
  <div class="main-content-area">
    <!-- å·¦å´: ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <div class="canvas-section">
      <!-- ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
      <div class="canvas-wrapper">

        <!-- ã‚¢ãƒ«ãƒãƒ è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šï¼‰ -->
   <div class="canvas-top-right-btn">
    <%= link_to albums_index_path, class: "btn btn-primary add-album-btn" do %>
      <i class="fas fa-plus me-2"></i>ã‚¢ãƒ«ãƒãƒ ã‚’è¿½åŠ 
    <% end %>
    <!-- ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ  -->
    <% if @favorite_albums.any? %>
      <button class="btn btn-danger ms-2 bulk-delete-btn" onclick="showBulkDeleteModal()">
        <i class="fas fa-trash me-2"></i>ä¸€æ‹¬å‰Šé™¤
      </button>
    <% end %>
  </div>

        <!-- ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
        <div class="collection-canvas" id="canvas">
          <% if @favorite_albums.any? %>
            <% @favorite_albums.each_with_index do |album, index| %>
              <%
                # ğŸ†• ä¿å­˜ã•ã‚ŒãŸä½ç½®ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’è¨ˆç®—
                if album.position_x.present? && album.position_y.present?
                  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚ŒãŸä½ç½®ã‚’ä½¿ç”¨
                  position_x = album.position_x
                  position_y = album.position_y
                  grid_x = (position_x / 140).to_i
                  grid_y = (position_y / 140).to_i
                else
                  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã‚’è¨ˆç®—
                  grid_x = index % 5
                  grid_y = (index / 5).floor
                  position_x = grid_x * 140
                  position_y = grid_y * 140
                end
              %>
              <div class="album-jacket"
                   data-id="<%= album.id %>"
                   data-spotify-id="<%= album.spotify_id %>"
                   data-grid-x="<%= grid_x %>"
                   data-grid-y="<%= grid_y %>"
                   data-album-name="<%= album.name %>"
                   data-artist-name="<%= album.artist %>"
                   style="top: <%= position_y %>px; left: <%= position_x %>px;">
                <img src="<%= album.image_url %>" alt="<%= album.name %>">
                <button class="delete-btn" onclick="removeAlbum(this, '<%= album.spotify_id %>')">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            <% end %>
          <% else %>
            <div class="empty-state">
              <i class="fas fa-compact-disc"></i>
              <h4>ã¾ã ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“</h4>
              <p>æ¤œç´¢ç”»é¢ã§ãŠæ°—ã«å…¥ã‚Šã®ã‚¢ãƒ«ãƒãƒ ã‚¸ãƒ£ã‚±ãƒƒãƒˆã‚’é¸ã‚“ã§ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ ã—ã¾ã—ã‚‡ã†ï¼</p>
              <%= link_to "ã‚¢ãƒ«ãƒãƒ ã‚’æ¤œç´¢", albums_index_path, class: "btn btn-primary mt-3" %>
            </div>
          <% end %>
        </div>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆå³ä¸‹ï¼‰ -->
        <div class="canvas-bottom-right-btn">
          <button class="btn btn-info preview-btn" onclick="previewShareImage()" id="previewBtn">
            <i class="fas fa-eye me-2"></i>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
          </button>
          
          <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
          <button class="btn btn-success ms-2" onclick="saveCollection()" id="saveBtn">
            <i class="fas fa-save me-2"></i>ä¿å­˜
          </button>
        </div>
      </div>
    </div>

    <!-- å³å´: ã‚¢ãƒ«ãƒãƒ ãƒªã‚¹ãƒˆ -->
    <div class="ranking-section">
  <div class="ranking-container">
    
    
    <div class="album-list" id="albumList">
      <% if @favorite_albums.any? %>
        <% 
          # ä½ç½®ã«åŸºã¥ã„ã¦ã‚½ãƒ¼ãƒˆï¼ˆå·¦ä¸Šã‹ã‚‰å³ä¸‹ã¸ï¼‰
          sorted_albums = @favorite_albums.sort_by do |album|
            if album.position_x.present? && album.position_y.present?
              grid_y = (album.position_y / 140).to_i
              grid_x = (album.position_x / 140).to_i
            else
              # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã§ã‚½ãƒ¼ãƒˆ
              index = @favorite_albums.index(album)
              grid_y = (index / 5).floor
              grid_x = index % 5
            end
            [grid_y, grid_x]  # Yåº§æ¨™å„ªå…ˆã€æ¬¡ã«Xåº§æ¨™ã§ã‚½ãƒ¼ãƒˆ
          end
        %>
        <% sorted_albums.each_with_index do |album, display_index| %>
          <div class="album-list-item" data-grid-position="<%= display_index %>" data-spotify-id="<%= album.spotify_id %>">
            <span class="album-number"><%= display_index + 1 %></span>
            <span class="album-title"><%= album.name %></span>
            <span class="artist-name"><%= album.artist %></span>
          </div>
        <% end %>
      <% else %>
        <div class="empty-album-list">
          <i class="fas fa-music fa-2x text-muted mb-3"></i>
          <p class="text-muted">ã‚¢ãƒ«ãƒãƒ ã‚’è¿½åŠ ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- SNSå…±æœ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="shareModalLabel">
          <i class="fas fa-share-alt me-2"></i>åç›¤ãƒªã‚¹ãƒˆã‚’SNSã«å…±æœ‰
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <p class="mb-4">ã‚ãªãŸã®åç›¤ãƒªã‚¹ãƒˆã‚’å‹é”ã«ã‚·ã‚§ã‚¢ã—ã¾ã—ã‚‡ã†ï¼</p>
          
          <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="mb-4 p-3 bg-light rounded">
            <h6 class="fw-bold mb-2">
              <i class="fas fa-eye me-2"></i>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
            </h6>
            <p class="text-muted small mb-3">ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ã‚¢ãƒ«ãƒãƒ ãƒªã‚¹ãƒˆã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºã—ã¾ã™</p>
            <button class="btn btn-primary btn-lg" onclick="previewShareImage()" id="previewImageBtn">
              <i class="fas fa-eye me-2"></i>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            </button>
            <div id="previewProgress" class="mt-3" style="display: none;">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­...</span>
              </div>
              <p class="mt-2 text-muted">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆä¸­ã§ã™...</p>
            </div>
          </div>

          <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
          <div id="previewArea" class="mb-4" style="display: none;">
            <h6 class="fw-bold mb-2">
              <i class="fas fa-image me-2"></i>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            </h6>
            <div class="text-center">
              <img id="previewImage" class="img-fluid border rounded" style="max-width: 100%; max-height: 400px;" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒ">
            </div>
            <div class="mt-3 text-center">
              <button class="btn btn-success btn-lg" onclick="generateShareImage()" id="generateImageBtn">
                <i class="fas fa-download me-2"></i>ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
              </button>
              <button class="btn btn-info btn-lg ms-2" onclick="shareToSNS()" id="shareSNSBtn">
                <i class="fas fa-share-alt me-2"></i>SNSã§ã‚·ã‚§ã‚¢
              </button>
            </div>
          </div>
          
          <hr class="my-4">
          
          <div class="d-grid gap-3" style="max-width: 400px; margin: 0 auto;">
            <a href="#" class="btn btn-primary btn-lg sns-share-btn" onclick="shareToTwitter()">
              <i class="fab fa-x-twitter me-2"></i>X (Twitter) ã§ã‚·ã‚§ã‚¢
            </a>
            <a href="#" class="btn btn-danger btn-lg sns-share-btn" onclick="shareToInstagram()">
              <i class="fab fa-instagram me-2"></i>Instagram ã§ã‚·ã‚§ã‚¢
            </a>
            <a href="#" class="btn btn-success btn-lg sns-share-btn" onclick="shareToLine()">
              <i class="fab fa-line me-2"></i>LINE ã§ã‚·ã‚§ã‚¢
            </a>
            <button class="btn btn-secondary btn-lg" onclick="copyLink()">
              <i class="fas fa-link me-2"></i>ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- ä¸€æ‹¬å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title fw-bold" id="bulkDeleteModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>ä¸€æ‹¬å‰Šé™¤ã®ç¢ºèª
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center">
          <div class="mb-4">
            <i class="fas fa-trash fa-3x text-danger mb-3"></i>
            <h6 class="fw-bold">å…¨ã¦ã®ã‚¢ãƒ«ãƒãƒ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h6>
            <p class="text-muted">ç¾åœ¨ <span id="album-count"><%= @favorite_albums.count %></span> æšã®ã‚¢ãƒ«ãƒãƒ ãŒã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚ã‚Šã¾ã™ã€‚</p>
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼</strong>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>ã„ã„ãˆ
        </button>
        <button type="button" class="btn btn-danger" onclick="executeBulkDelete()">
          <i class="fas fa-trash me-2"></i>ã¯ã„
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.collection-container {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  min-height: calc(100vh - 140px);
  position: relative;
}

.main-content-area {
  display: flex;
  gap: 30px;
  align-items: flex-start;
}

.canvas-section {
  flex: 0 0 auto;
  position: relative;
}

.canvas-wrapper {
  position: relative;
  display: inline-block;
}

/* ãƒœã‚¿ãƒ³é…ç½® */
.canvas-top-right-btn {
  position: absolute;
  top: -60px;
  right: 0;
  z-index: 10;
}

.canvas-bottom-right-btn {
  position: absolute;
  bottom: -60px;
  right: 0;
  z-index: 10;
}

.add-album-btn {
  background: linear-gradient(135deg, #667eea, #764ba2);
  border: none;
  color: white;
  padding: 12px 20px;
  border-radius: 25px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  text-decoration: none;
}

.add-album-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
  color: white;
  text-decoration: none;
}

.share-sns-btn {
  background: linear-gradient(135deg, #28a745, #20c997);
  border: none;
  color: white;
  padding: 12px 20px;
  border-radius: 25px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.share-sns-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
  color: white;
}

/* ã‚­ãƒ£ãƒ³ãƒã‚¹ */
.collection-canvas {
  width: 700px;
  height: 700px;
  background-color: #000000;
  background-image:
      linear-gradient(rgba(255,255,255,0.2) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255,255,255,0.2) 1px, transparent 1px);
  background-size: 140px 140px;
  position: relative;
  border: 2px solid #333;
  border-radius: 15px;
  overflow: hidden;
}

.album-jacket {
  position: absolute;
  width: 140px;
  height: 140px;
  cursor: move;
  border-radius: 0;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.1);
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  background: white;
  padding: 0;
  user-select: none;
  border: 1px solid rgba(255,255,255,0.1);
}

.album-jacket img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 0;
  display: block;
}

.album-jacket:hover {
  transform: scale(1.05) translateY(-5px);
  box-shadow: 0 15px 35px rgba(255,255,255,0.4);
  z-index: 100;
}

.album-jacket.hover-linked {
  transform: scale(1.05) translateY(-5px);
  box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
  z-index: 100;
  border: 2px solid #667eea;
}

.album-jacket.dragging {
  transform: rotate(5deg) scale(1.1);
  box-shadow: 0 15px 35px rgba(0,0,0,0.4);
  z-index: 1000;
}

.delete-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  width: 24px;
  height: 24px;
  background: rgba(220, 53, 69, 0.9);
  color: white;
  border: none;
  border-radius: 50%;
  font-size: 12px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 101;
}

.album-jacket:hover .delete-btn {
  opacity: 1;
}

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #ffffff;
}

.empty-state i {
  font-size: 4rem;
  margin-bottom: 20px;
  opacity: 0.5;
  color: #ffffff;
}

/* å³å´ã‚¢ãƒ«ãƒãƒ ãƒªã‚¹ãƒˆ - ç•ªå·ä»˜ããƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
.ranking-section {
  flex: 1;
  min-width: 400px;
  max-width: 500px;
}

.ranking-container {
  background: #000000; /* é»’èƒŒæ™¯ */
  border-radius: 15px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3); /* ã‚·ãƒ£ãƒ‰ã‚¦ã‚’å¼·åŒ– */
  height: 742px;
  display: flex;
  flex-direction: column;
  position: sticky;
  top: 20px;
  border: 1px solid #333; /* è–„ã„ãƒœãƒ¼ãƒ€ãƒ¼ã‚’è¿½åŠ  */
}

.ranking-header {
  flex: 0 0 auto;
  border-bottom: 2px solid #333; /* ãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ã®ãƒœãƒ¼ãƒ€ãƒ¼ */
  padding-bottom: 15px;
  margin-bottom: 15px;
  color: #ffffff; /* ç™½æ–‡å­— */
}

.album-list {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 3px;
  overflow: hidden;
  height: 100%;
}

.album-list-item {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  background: #1a1a1a;
  border-radius: 6px;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  border: 1px solid #333;
  height: calc((100% - 72px) / 25);
  min-height: 20px;
  white-space: nowrap;
  gap: 8px; /* ğŸ†• è¦ç´ é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å°‘ã—ç¸®å° */
}

.album-list-item:hover {
  background: #2a2a2a; /* ãƒ›ãƒãƒ¼æ™‚ã«ã‚ˆã‚Šæ˜ã‚‹ã„ã‚°ãƒ¬ãƒ¼ */
  transform: translateX(5px) translateY(-2px);
  box-shadow: 0 5px 15px rgba(255,255,255,0.1); /* ç™½ã„ã‚·ãƒ£ãƒ‰ã‚¦ */
  border-color: #555; /* ãƒ›ãƒãƒ¼æ™‚ã®ãƒœãƒ¼ãƒ€ãƒ¼ */
}

.album-list-item.hover-linked {
  background: rgba(102, 126, 234, 0.2); /* é’ã®é€æ˜åº¦ã‚’ä¸Šã’ã‚‹ */
  border-color: #667eea;
  transform: translateX(5px) translateY(-2px);
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.album-list-item.highlighted {
  background: rgba(102, 126, 234, 0.3); /* ãƒã‚¤ãƒ©ã‚¤ãƒˆæ™‚ */
  border-color: #667eea;
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
  transform: translateX(10px) translateY(-5px);
}

/* ğŸ†• ç•ªå·ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.album-number {
  font-weight: 700;
  font-size: 14px;
  color: #667eea;
  min-width: 24px;
  text-align: center;
  flex-shrink: 0;
  background: rgba(102, 126, 234, 0.1);
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid rgba(102, 126, 234, 0.3);
}

.album-title {
  font-weight: 600;
  font-size: 12px;
  color: #ffffff;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1; /* ğŸ†• åˆ©ç”¨å¯èƒ½ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ç”¨ */
  text-align: left;
  min-width: 0; /* ğŸ†• ç¸®å°ã‚’è¨±å¯ */
  margin-right: 8px; /* ğŸ†• å³ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¸®å° */
}

.artist-name {
  font-size: 10px;
  color: #cccccc;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 0 0 auto; /* ğŸ†• å›ºå®šã‚µã‚¤ã‚º */
  max-width: 150px; /* ğŸ†• æœ€å¤§å¹…ã‚’æ‹¡å¤§ */
  min-width: 80px; /* ğŸ†• æœ€å°å¹…ã‚’ç¢ºä¿ */
  text-align: right;

.empty-album-list i{
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  text-align: center;
  color:white;

}


/* ãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚ã‚‹å ´åˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
.ranking-header h3,
.ranking-header h4,
.ranking-header h5 {
  color: #ffffff;
  margin: 0;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼ˆWebkitç³»ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ */
.album-list::-webkit-scrollbar {
  width: 6px;
}

.album-list::-webkit-scrollbar-track {
  background: #1a1a1a;
  border-radius: 3px;
}

.album-list::-webkit-scrollbar-thumb {
  background: #555;
  border-radius: 3px;
}

.album-list::-webkit-scrollbar-thumb:hover {
  background: #777;
}

/* ğŸ†• ãƒ›ãƒãƒ¼æ™‚ã®ç•ªå·ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.album-list-item:hover .album-number {
  background: rgba(102, 126, 234, 0.2);
  border-color: rgba(102, 126, 234, 0.5);
  color: #8fa4f3;
}

.album-list-item.hover-linked .album-number,
.album-list-item.highlighted .album-number {
  background: rgba(102, 126, 234, 0.4);
  border-color: #667eea;
  color: #ffffff;
}
/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal-content {
  border-radius: 20px;
  border: none;
  box-shadow: 0 20px 40px rgba(0,0,0,0.1);
}

.modal-header {
  border-bottom: 1px solid #eee;
  background: linear-gradient(135deg, #f8f9fa, #e9ecef);
  border-radius: 20px 20px 0 0;
}

.sns-share-btn {
  transition: all 0.3s ease;
}

.sns-share-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
@media (max-width: 1200px) {
  .main-content-area {
    flex-direction: column;
  }
  
  .ranking-section {
    max-width: none;
    width: 100%;
  }
  
  .canvas-top-right-btn {
    position: static;
    margin-bottom: 20px;
    text-align: right;
  }
  
  .canvas-bottom-right-btn {
    position: static;
    margin-top: 20px;
    text-align: right;
  }
  
  .ranking-container {
    height: auto;
    max-height: 500px;
    position: relative;
  }
  
  .album-list {
    overflow-y: auto;
  }
}

@media (max-width: 768px) {
  .canvas-top-right-btn,
  .canvas-bottom-right-btn {
    text-align: center;
  }
  
  .add-album-btn,
  .share-sns-btn {
    width: 100%;
    max-width: 250px;
  }
}

/* ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ */
.bulk-delete-btn {
  background: linear-gradient(135deg, #dc3545, #c82333);
  border: none;
  color: white;
  padding: 12px 20px;
  border-radius: 25px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
}

.bulk-delete-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(220, 53, 69, 0.4);
  color: white;
}

.bulk-delete-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* å‰Šé™¤ä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.album-jacket.deleting {
  animation: deleteAnimation 0.5s ease-out forwards;
}

@keyframes deleteAnimation {
  0% {
    opacity: 1;
    transform: scale(1) rotate(0deg);
  }
  50% {
    opacity: 0.5;
    transform: scale(1.1) rotate(180deg);
  }
  100% {
    opacity: 0;
    transform: scale(0) rotate(360deg);
  }
}

/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
.bulk-delete-progress {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 9999;
  background: white;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  text-align: center;
  min-width: 300px;
}

.album-jacket.collision-preview {
  border: 2px dashed #ffc107 !important;
  background-color: rgba(255, 193, 7, 0.1) !important;
  transform: scale(1.02) !important;
  transition: all 0.2s ease !important;
}

.album-jacket.dragging {
  transform: rotate(5deg) scale(1.1) !important;
  box-shadow: 0 15px 35px rgba(0,0,0,0.4) !important;
  z-index: 1000 !important;
  border: 2px solid #667eea !important;
  transition: none !important;
}

/* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚­ãƒ£ãƒ³ãƒã‚¹çŠ¶æ…‹ */
.collection-canvas.dragging-active {
  cursor: grabbing !important;
}

.collection-canvas.dragging-active .album-jacket:not(.dragging) {
  pointer-events: none;
  opacity: 0.7;
}

/* ã‚ˆã‚Šæ˜ç¢ºãªè¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
.album-jacket.dragging {
  box-shadow: 
    0 15px 35px rgba(0,0,0,0.4),
    0 0 0 3px rgba(102, 126, 234, 0.3) !important;
}

/* ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¹ã‚¿ã‚¤ãƒ« */
.guest-notice {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 15px 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  text-align: center;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.guest-notice i {
  margin-right: 8px;
}

/* ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ï¼‰ */
.btn-warning {
  background: linear-gradient(135deg, #ffc107, #ff8c00);
  border: none;
  color: white;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
}

.btn-warning:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4);
  color: white;
  background: linear-gradient(135deg, #ffb300, #ff6f00);
}
</style>


<script>
  
// ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸å°‚ç”¨JavaScript
let isDragging = false;
let currentElement = null;
let startX = 0;
let startY = 0;
let selectedAlbum = null;
let occupiedPositions = new Map();
let saveTimeout = null;
let dragOffset = { x: 0, y: 0 };

document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ”§ Initializing collection page...');
  checkCSRFToken();
  updateOccupiedPositions();
  initializeDragAndDrop();
  updateAlbumList();
  initializeHoverLinks();
});

// CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã®çŠ¶æ…‹ç¢ºèª
function checkCSRFToken() {
  const token = document.querySelector('[name="csrf-token"]')?.getAttribute('content') || 
               document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  
  console.log('ğŸ” CSRF Token check:', {
    found: !!token,
    length: token?.length,
    preview: token?.substring(0, 10) + '...'
  });
  
  return token;
}

// ãƒ›ãƒãƒ¼é€£å‹•æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
function initializeHoverLinks() {
  const albums = document.querySelectorAll('.album-jacket');
  const listItems = document.querySelectorAll('.album-list-item');
  
  albums.forEach(album => {
    album.addEventListener('mouseenter', function() {
      if (!isDragging) {
        const spotifyId = this.dataset.spotifyId;
        linkHover(spotifyId, true);
      }
    });
    
    album.addEventListener('mouseleave', function() {
      if (!isDragging) {
        const spotifyId = this.dataset.spotifyId;
        linkHover(spotifyId, false);
      }
    });
  });
  
  listItems.forEach(item => {
    item.addEventListener('mouseenter', function() {
      const spotifyId = this.dataset.spotifyId;
      linkHover(spotifyId, true);
    });
    
    item.addEventListener('mouseleave', function() {
      const spotifyId = this.dataset.spotifyId;
      linkHover(spotifyId, false);
    });
  });
}

// ãƒ›ãƒãƒ¼é€£å‹•é–¢æ•°
function linkHover(spotifyId, isHover) {
  const albumElement = document.querySelector(`.album-jacket[data-spotify-id="${spotifyId}"]`);
  const listElement = document.querySelector(`.album-list-item[data-spotify-id="${spotifyId}"]`);
  
  if (isHover) {
    if (albumElement) albumElement.classList.add('hover-linked');
    if (listElement) listElement.classList.add('hover-linked');
  } else {
    if (albumElement) albumElement.classList.remove('hover-linked');
    if (listElement) listElement.classList.remove('hover-linked');
  }
}

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—åˆæœŸåŒ–
function initializeDragAndDrop() {
  const albums = document.querySelectorAll('.album-jacket');
  const canvas = document.getElementById('canvas');

  albums.forEach(album => {
    album.addEventListener('mousedown', function(e) {
      if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
        return;
      }

      isDragging = true;
      currentElement = this;
      canvas.classList.add('dragging-active');

      albums.forEach(a => a.classList.remove('selected', 'hover-linked'));
      this.classList.add('dragging');
      selectedAlbum = this;

      const rect = this.getBoundingClientRect();
      const canvasRect = canvas.getBoundingClientRect();
      
      dragOffset.x = e.clientX - rect.left;
      dragOffset.y = e.clientY - rect.top;

      const currentGridX = parseInt(this.dataset.gridX);
      const currentGridY = parseInt(this.dataset.gridY);
      
      this.dataset.originalGridX = currentGridX;
      this.dataset.originalGridY = currentGridY;
      
      const currentPosKey = `${currentGridX},${currentGridY}`;
      if (occupiedPositions.has(currentPosKey)) {
        occupiedPositions.delete(currentPosKey);
        console.log(`ğŸ”„ Temporarily removed position: ${currentPosKey}`);
      }

      this.style.zIndex = '1000';
      
      e.preventDefault();
    });
  });

  document.addEventListener('mousemove', function(e) {
    if (!isDragging || !currentElement) return;

    const canvasRect = canvas.getBoundingClientRect();
    
    const newX = e.clientX - canvasRect.left - dragOffset.x;
    const newY = e.clientY - canvasRect.top - dragOffset.y;

    const boundedX = Math.max(0, Math.min(560, newX));
    const boundedY = Math.max(0, Math.min(560, newY));

    const gridX = Math.round(boundedX / 140);
    const gridY = Math.round(boundedY / 140);
    
    const clampedGridX = Math.max(0, Math.min(4, gridX));
    const clampedGridY = Math.max(0, Math.min(4, gridY));
    
    const snapX = clampedGridX * 140;
    const snapY = clampedGridY * 140;
    
    currentElement.style.left = snapX + 'px';
    currentElement.style.top = snapY + 'px';
    currentElement.dataset.gridX = clampedGridX;
    currentElement.dataset.gridY = clampedGridY;

    const targetAlbum = findAlbumAtPosition(clampedGridX, clampedGridY, currentElement);
    if (targetAlbum) {
      targetAlbum.classList.add('collision-preview');
    } else {
      document.querySelectorAll('.collision-preview').forEach(el => {
        el.classList.remove('collision-preview');
      });
    }
  });

  document.addEventListener('mouseup', function() {
    if (!currentElement) return;

    currentElement.classList.remove('dragging');
    currentElement.style.zIndex = '';
    canvas.classList.remove('dragging-active');
    
    document.querySelectorAll('.collision-preview').forEach(el => {
      el.classList.remove('collision-preview');
    });
    
    const newGridX = parseInt(currentElement.dataset.gridX);
    const newGridY = parseInt(currentElement.dataset.gridY);
    const originalGridX = parseInt(currentElement.dataset.originalGridX);
    const originalGridY = parseInt(currentElement.dataset.originalGridY);
    
    console.log('ğŸ¯ Drop detected:', {
      album: currentElement.dataset.albumName,
      from: `${originalGridX},${originalGridY}`,
      to: `${newGridX},${newGridY}`,
      moved: originalGridX !== newGridX || originalGridY !== newGridY
    });
    
    if (originalGridX !== newGridX || originalGridY !== newGridY) {
      const targetAlbum = findAlbumAtPosition(newGridX, newGridY, currentElement);
      
      if (targetAlbum) {
        console.log('ğŸ”„ Executing album swap...');
        executeAlbumSwap(currentElement, targetAlbum, originalGridX, originalGridY);
      } else {
        console.log('ğŸ“ Moving to empty position...');
        moveToEmptyPosition(currentElement);
      }
    } else {
      console.log('ğŸ“ No position change, restoring original position...');
      occupiedPositions.set(`${originalGridX},${originalGridY}`, {
        albumId: currentElement.dataset.id,
        albumName: currentElement.dataset.albumName
      });
    }
    
    delete currentElement.dataset.originalGridX;
    delete currentElement.dataset.originalGridY;
    
    currentElement = null;
    isDragging = false;
    
    setTimeout(() => {
      updateAlbumList();
      initializeHoverLinks();
    }, 150);
  });
}

// ã‚¢ãƒ«ãƒãƒ äº¤æ›å‡¦ç†
function executeAlbumSwap(movingAlbum, targetAlbum, originalGridX, originalGridY) {
  targetAlbum.style.left = (originalGridX * 140) + 'px';
  targetAlbum.style.top = (originalGridY * 140) + 'px';
  targetAlbum.dataset.gridX = originalGridX;
  targetAlbum.dataset.gridY = originalGridY;
  
  const newPos = `${movingAlbum.dataset.gridX},${movingAlbum.dataset.gridY}`;
  const originalPos = `${originalGridX},${originalGridY}`;
  
  occupiedPositions.set(newPos, {
    albumId: movingAlbum.dataset.id,
    albumName: movingAlbum.dataset.albumName
  });
  
  occupiedPositions.set(originalPos, {
    albumId: targetAlbum.dataset.id,
    albumName: targetAlbum.dataset.albumName
  });
  
  console.log('ğŸ”„ Swap completed:', {
    moving: `${movingAlbum.dataset.albumName} â†’ ${newPos}`,
    target: `${targetAlbum.dataset.albumName} â†’ ${originalPos}`
  });
  
  saveBothAlbumPositions(movingAlbum, targetAlbum);
}

// ç©ºã®ä½ç½®ã¸ã®ç§»å‹•å‡¦ç†
function moveToEmptyPosition(album) {
  const newPos = `${album.dataset.gridX},${album.dataset.gridY}`;
  
  occupiedPositions.set(newPos, {
    albumId: album.dataset.id,
    albumName: album.dataset.albumName
  });
  
  console.log('ğŸ“ Moved to empty position:', {
    album: album.dataset.albumName,
    position: newPos
  });
  
  saveAlbumPosition(album);
}

// æŒ‡å®šã•ã‚ŒãŸä½ç½®ã«ã‚ã‚‹ã‚¢ãƒ«ãƒãƒ ã‚’è¦‹ã¤ã‘ã‚‹é–¢æ•°
function findAlbumAtPosition(gridX, gridY, excludeAlbum = null) {
  const positionKey = `${gridX},${gridY}`;
  
  if (occupiedPositions.has(positionKey)) {
    const occupant = occupiedPositions.get(positionKey);
    console.log(`ğŸ¯ Position ${positionKey} is occupied by:`, occupant);
  }
  
  const albums = document.querySelectorAll('.album-jacket');
  for (let album of albums) {
    if (album === excludeAlbum) continue;
    
    const albumGridX = parseInt(album.dataset.gridX);
    const albumGridY = parseInt(album.dataset.gridY);
    
    if (albumGridX === gridX && albumGridY === gridY) {
      console.log(`ğŸ¯ Found album at position ${gridX},${gridY}:`, album.dataset.albumName);
      return album;
    }
  }
  
  return null;
}

// ä¸¡æ–¹ã®ã‚¢ãƒ«ãƒãƒ ã®ä½ç½®ã‚’åŒæ™‚ã«ä¿å­˜ã™ã‚‹é–¢æ•°
function saveBothAlbumPositions(album1, album2) {
  const layoutData = [
    {
      id: album1.dataset.id,
      x: parseInt(album1.style.left),
      y: parseInt(album1.style.top),
      grid_x: parseInt(album1.dataset.gridX),
      grid_y: parseInt(album1.dataset.gridY)
    },
    {
      id: album2.dataset.id,
      x: parseInt(album2.style.left),
      y: parseInt(album2.style.top),
      grid_x: parseInt(album2.dataset.gridX),
      grid_y: parseInt(album2.dataset.gridY)
    }
  ];
  
  console.log('ğŸ”„ Saving positions for both albums:', {
    album1: {
      id: album1.dataset.id,
      name: album1.dataset.albumName,
      position: layoutData[0]
    },
    album2: {
      id: album2.dataset.id,
      name: album2.dataset.albumName,
      position: layoutData[1]
    }
  });
  
  performPositionSave(layoutData, [album1, album2]);
}

// ä½ç½®ä¿å­˜æ©Ÿèƒ½ï¼ˆå˜ä¸€ã‚¢ãƒ«ãƒãƒ ç”¨ï¼‰
function saveAlbumPosition(albumElement) {
  const albumId = albumElement.dataset.id;
  const positionX = parseInt(albumElement.style.left);
  const positionY = parseInt(albumElement.style.top);
  const gridX = parseInt(albumElement.dataset.gridX);
  const gridY = parseInt(albumElement.dataset.gridY);
  
  if (!albumId || isNaN(positionX) || isNaN(positionY) || isNaN(gridX) || isNaN(gridY)) {
    console.error('âŒ Invalid data for position save:', {
      albumId, positionX, positionY, gridX, gridY
    });
    showMessage('ä½ç½®ãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™', 'error');
    return;
  }
  
  console.log(`ğŸ’¾ Saving position for album ${albumId}:`, {
    id: albumId,
    name: albumElement.dataset.albumName,
    pixel: { x: positionX, y: positionY },
    grid: { x: gridX, y: gridY }
  });
  
  if (saveTimeout) {
    clearTimeout(saveTimeout);
  }
  
  saveTimeout = setTimeout(() => {
    const layoutData = [{
      id: albumId,
      x: positionX,
      y: positionY,
      grid_x: gridX,
      grid_y: gridY
    }];
    
    performPositionSave(layoutData, [albumElement]);
  }, 100);
}

// å®Ÿéš›ã®ä¿å­˜å‡¦ç†ã‚’å…±é€šåŒ–
function performPositionSave(layoutData, albumElements) {
  const csrfToken = document.querySelector('[name="csrf-token"]')?.getAttribute('content') || 
                   document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  
  if (!csrfToken) {
    console.error('âŒ CSRF token not found');
    showMessage('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
    return;
  }
  
  console.log('ğŸ“¤ Sending position update:', layoutData);
  
  fetch('/favorite_albums/update_layout', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken,
      'Accept': 'application/json'
    },
    body: JSON.stringify({ layout: layoutData })
  })
  .then(response => {
    console.log('ğŸ“¥ Response status:', response.status);
    
    if (!response.ok) {
      return response.text().then(text => {
        console.error('âŒ Server response:', text);
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      });
    }
    return response.json();
  })
  .then(data => {
    console.log('âœ… Position save response:', data);
    
    if (data.status === 'success') {
      console.log('ğŸ’¾ Positions saved successfully');
      albumElements.forEach(element => showTemporaryIndicator(element));
    } else {
      console.error('âŒ Server error:', data.message);
      showMessage('ä½ç½®ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.message, 'error');
    }
  })
  .catch(error => {
    console.error('âŒ Position save error:', error);
    showMessage('ä½ç½®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
    
    albumElements.forEach(element => {
      if (element.dataset.originalGridX && element.dataset.originalGridY) {
        const originalX = parseInt(element.dataset.originalGridX) * 140;
        const originalY = parseInt(element.dataset.originalGridY) * 140;
        element.style.left = originalX + 'px';
        element.style.top = originalY + 'px';
        element.dataset.gridX = element.dataset.originalGridX;
        element.dataset.gridY = element.dataset.originalGridY;
      }
    });
    updateOccupiedPositions();
  });
}

// ä½ç½®ä¿å­˜ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
function showTemporaryIndicator(albumElement) {
  const indicator = document.createElement('div');
  indicator.innerHTML = '<i class="fas fa-save"></i>';
  indicator.style.cssText = `
    position: absolute;
    top: 5px;
    left: 5px;
    width: 20px;
    height: 20px;
    background: rgba(40, 167, 69, 0.8);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    z-index: 102;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  `;
  
  setTimeout(() => indicator.style.opacity = '1', 50);
  
  setTimeout(() => {
    indicator.style.opacity = '0';
    setTimeout(() => {
      if (indicator.parentNode) {
        indicator.parentNode.removeChild(indicator);
      }
    }, 300);
  }, 1500);
}

// å æœ‰ä½ç½®æ›´æ–°
function updateOccupiedPositions() {
  occupiedPositions.clear();
  const positionData = [];
  const duplicateCheck = new Set();
  
  document.querySelectorAll('.album-jacket').forEach(album => {
    const gridX = parseInt(album.dataset.gridX);
    const gridY = parseInt(album.dataset.gridY);
    
    if (isNaN(gridX) || isNaN(gridY)) {
      console.warn(`âš ï¸ Invalid coordinates for album ${album.dataset.albumName}:`, {
        gridX, gridY, 
        styleLeft: album.style.left, 
        styleTop: album.style.top
      });
      
      const styleX = parseInt(album.style.left) || 0;
      const styleY = parseInt(album.style.top) || 0;
      const correctedGridX = Math.round(styleX / 140);
      const correctedGridY = Math.round(styleY / 140);
      
      album.dataset.gridX = correctedGridX;
      album.dataset.gridY = correctedGridY;
      
      console.log(`ğŸ”§ Corrected coordinates:`, { 
        gridX: correctedGridX, 
        gridY: correctedGridY 
      });
    }
    
    const posKey = `${album.dataset.gridX},${album.dataset.gridY}`;
    
    if (duplicateCheck.has(posKey)) {
      console.error(`âŒ DUPLICATE POSITION DETECTED: ${posKey}`, {
        album: album.dataset.albumName,
        id: album.dataset.id
      });
      
      const newPosition = findEmptyPosition();
      album.style.left = newPosition.x + 'px';
      album.style.top = newPosition.y + 'px';
      album.dataset.gridX = newPosition.gridX;
      album.dataset.gridY = newPosition.gridY;
      
      console.log(`ğŸ”§ Auto-corrected to:`, newPosition);
    } else {
      duplicateCheck.add(posKey);
    }
    
    occupiedPositions.set(posKey, {
      albumId: album.dataset.id,
      albumName: album.dataset.albumName,
      element: album
    });
    
    positionData.push({
      name: album.dataset.albumName,
      id: album.dataset.id,
      gridPos: posKey,
      coordinates: { x: album.style.left, y: album.style.top }
    });
  });
  
  console.log('ğŸ—ºï¸ Updated position map:', {
    totalPositions: occupiedPositions.size,
    positions: Array.from(occupiedPositions.keys()),
    details: positionData
  });
}

// ç©ºã„ã¦ã„ã‚‹ä½ç½®ã‚’è¦‹ã¤ã‘ã‚‹é–¢æ•°
function findEmptyPosition() {
  for (let y = 0; y < 5; y++) {
    for (let x = 0; x < 5; x++) {
      const posKey = `${x},${y}`;
      if (!occupiedPositions.has(posKey)) {
        return {
          x: x * 140,
          y: y * 140,
          gridX: x,
          gridY: y
        };
      }
    }
  }
  
  console.warn('âš ï¸ No empty positions available, returning (0,0)');
  return { x: 0, y: 0, gridX: 0, gridY: 0 };
}

// ã‚¢ãƒ«ãƒãƒ ãƒªã‚¹ãƒˆæ›´æ–°
function updateAlbumList() {
  const albums = Array.from(document.querySelectorAll('.album-jacket'));
  const albumList = document.getElementById('albumList');
  
  if (albums.length === 0) {
    albumList.innerHTML = `
      <div class="empty-album-list">
        <i class="fas fa-music fa-2x text-muted mb-3"></i>
        <p class="text-muted">ã‚¢ãƒ«ãƒãƒ ã‚’è¿½åŠ ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
      </div>
    `;
    return;
  }
  
  albums.sort((a, b) => {
    const aGridY = parseInt(a.dataset.gridY);
    const bGridY = parseInt(b.dataset.gridY);
    const aGridX = parseInt(a.dataset.gridX);
    const bGridX = parseInt(b.dataset.gridX);
    
    if (aGridY !== bGridY) {
      return aGridY - bGridY;
    }
    return aGridX - bGridX;
  });
  
  let albumHTML = '';
  albums.forEach((album, index) => {
    const albumName = album.dataset.albumName || 'ä¸æ˜ãªã‚¢ãƒ«ãƒãƒ ';
    const artistName = album.dataset.artistName || 'ä¸æ˜ãªã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ';
    const spotifyId = album.dataset.spotifyId;
    
    albumHTML += `
      <div class="album-list-item" data-grid-position="${index}" data-spotify-id="${spotifyId}">
        <span class="album-number">${index + 1}</span>
        <span class="album-title">${albumName}</span>
        <span class="artist-name">${artistName}</span>
      </div>
    `;
  });
  
  albumList.innerHTML = albumHTML;
}

// å‰Šé™¤æ©Ÿèƒ½
function removeAlbum(btn, spotifyId) {
  if (confirm('ã“ã®ã‚¢ãƒ«ãƒãƒ ã‚’ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    const album = btn.closest('.album-jacket');
    const gridX = parseInt(album.dataset.gridX);
    const gridY = parseInt(album.dataset.gridY);
    
    occupiedPositions.delete(`${gridX},${gridY}`);
    
    fetch(`/favorite_albums/${spotifyId}`, {
      method: 'DELETE',
      headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').getAttribute('content')
      }
    })
    .then(response => {
      console.log('ğŸ“¥ Delete response status:', response.status);
      
      if (!response.ok) {
        return response.text().then(text => {
          console.error('âŒ Server response:', text);
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.status === 'removed') {
        album.style.opacity = '0';
        album.style.transform = 'scale(0)';
        setTimeout(() => {
          album.remove();
          updateAlbumList();
          initializeHoverLinks();
        }, 300);
        showMessage('ã‚¢ãƒ«ãƒãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
      } else {
        console.error('âŒ Unexpected response:', data);
        showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
      }
    })
    .catch(error => {
      console.error('âŒ Remove error:', error);
      showMessage('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
      
      // ä½ç½®æƒ…å ±ã‚’å¾©å…ƒ
      occupiedPositions.set(`${gridX},${gridY}`, {
        albumId: album.dataset.id,
        albumName: album.dataset.albumName
      });
    });
  }
}

// SNSå…±æœ‰æ©Ÿèƒ½
function shareToTwitter() {
  const albumCount = document.querySelectorAll('.album-jacket').length;
  const text = `ç§ã®åç›¤ãƒªã‚¹ãƒˆï¼ˆ${albumCount}æšï¼‰ã‚’ä½œæˆã—ã¾ã—ãŸï¼ #TuneBox #åç›¤ãƒªã‚¹ãƒˆ #éŸ³æ¥½å¥½ãã¨ç¹‹ãŒã‚ŠãŸã„`;
  const url = window.location.href;
  const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
  window.open(twitterUrl, '_blank', 'width=600,height=400');
}

function shareToInstagram() {
  const text = `ç§ã®åç›¤ãƒªã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¦ï¼ ${window.location.href} #TuneBox #åç›¤ãƒªã‚¹ãƒˆ`;
  
  if (navigator.userAgent.includes('Mobile')) {
    window.open('instagram://app', '_blank');
  } else {
    navigator.clipboard.writeText(text).then(() => {
      alert('æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼Instagramã§æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚');
    });
  }
}

function shareToLine() {
  const albumCount = document.querySelectorAll('.album-jacket').length;
  const text = `ç§ã®åç›¤ãƒªã‚¹ãƒˆï¼ˆ${albumCount}æšï¼‰ã‚’è¦‹ã¦ã¿ã¦ï¼`;
  const url = window.location.href;
  const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text + '\n' + url)}`;
  window.open(lineUrl, '_blank');
}

function copyLink() {
  navigator.clipboard.writeText(window.location.href).then(() => {
    const btn = document.querySelector('.btn-secondary');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check me-2"></i>ã‚³ãƒ”ãƒ¼å®Œäº†ï¼';
    setTimeout(() => {
      btn.innerHTML = originalText;
    }, 2000);
  }).catch(() => {
    alert('ãƒªãƒ³ã‚¯ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
  });
}

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½
            function previewShareImage() {
              const previewBtn = document.getElementById('previewBtn');

              // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
              previewBtn.disabled = true;
              previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ç”Ÿæˆä¸­...';

              // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ã‚¢ãƒ«ãƒãƒ ãƒªã‚¹ãƒˆã‚’ãã®ã¾ã¾ãƒ¢ãƒ¼ãƒ€ãƒ«ã§è¡¨ç¤º
              showPreviewModal();
              
              // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
              previewBtn.disabled = false;
              previewBtn.innerHTML = '<i class="fas fa-eye me-2"></i>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼';
            }

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            function showPreviewModal() {
              // ç¾åœ¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ã‚¢ãƒ«ãƒãƒ ãƒªã‚¹ãƒˆã®HTMLã‚’å–å¾—
              const canvas = document.querySelector('.collection-canvas');
              const albumList = document.querySelector('.album-list');
              
              // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®HTMLã‚’ä½œæˆ
              const modalHTML = `
                <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
                  <div class="modal-dialog" style="max-width: 1200px; width: 95%;">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="previewModalLabel">
                          <i class="fas fa-image me-2"></i>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body p-3">
                        <div class="collection-container" style="margin: 0;">
                          <div class="main-content-area" style="gap: 20px;">
                            <div class="canvas-section">
                              <div class="canvas-wrapper">
                                <div class="collection-canvas" id="previewCanvas" style="width: 700px; height: 700px;">
                                  ${canvas.innerHTML}
                                </div>
                              </div>
                            </div>
                            <div class="ranking-section" style="min-width: 400px;">
                              <div class="ranking-container" style="height: 742px;">
                                <div class="album-list" id="previewAlbumList">
                                  ${albumList.innerHTML}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                        <button type="button" class="btn btn-success share-sns-btn" onclick="shareToSNS()">
                          <i class="fas fa-share-alt me-2"></i>SNSã§ã‚·ã‚§ã‚¢
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              `;

              // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤
              const existingModal = document.getElementById('previewModal');
              if (existingModal) {
                existingModal.remove();
              }

              // æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ 
              document.body.insertAdjacentHTML('beforeend', modalHTML);

              // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
              const modal = new bootstrap.Modal(document.getElementById('previewModal'));
              modal.show();
              
              // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
              setTimeout(() => {
                const deleteButtons = document.querySelectorAll('#previewModal .delete-btn');
                deleteButtons.forEach(btn => {
                  btn.style.display = 'none';
                });
              }, 100);
            }

            // ç”»åƒç”Ÿæˆæ©Ÿèƒ½ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
            function generateShareImage() {
              const generateBtn = document.getElementById('generateImageBtn');

              // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
              generateBtn.disabled = true;
              generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...';

              // ç”»åƒç”Ÿæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
              fetch('/favorite_albums/generate_share_image', {
                method: 'GET',
                headers: {
                  'X-CSRF-Token': document.querySelector('[name="csrf-token"]').getAttribute('content')
                }
              })
              .then(response => {
                if (!response.ok) {
                  throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.blob();
              })
              .then(blob => {
                // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tunebox_share_${new Date().getTime()}.png`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                showMessage('ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');

                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-download me-2"></i>ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
              })
              .catch(error => {
                console.error('Image generation error:', error);
                showMessage('ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');

                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-download me-2"></i>ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
              });
            }

            // SNSå…±æœ‰æ©Ÿèƒ½
            function shareToSNS() {
              // SNSå…±æœ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
              showSNSShareModal();
            }

            // SNSå…±æœ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            function showSNSShareModal() {
              const albumCount = document.querySelectorAll('.album-jacket').length;
              const shareText = `ç§ã®åç›¤ãƒªã‚¹ãƒˆï¼ˆ${albumCount}æšï¼‰ã‚’ä½œæˆã—ã¾ã—ãŸï¼ #TuneBox #åç›¤ãƒªã‚¹ãƒˆ #éŸ³æ¥½å¥½ãã¨ç¹‹ãŒã‚ŠãŸã„`;
              const shareUrl = window.location.href;
              
              const modalHTML = `
                <div class="modal fade" id="snsShareModal" tabindex="-1" aria-labelledby="snsShareModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="snsShareModalLabel">
                          <i class="fas fa-share-alt me-2"></i>SNSã§ã‚·ã‚§ã‚¢
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <p class="text-muted mb-4">ãŠæ°—ã«å…¥ã‚Šã®SNSã§åç›¤ãƒªã‚¹ãƒˆã‚’ã‚·ã‚§ã‚¢ã—ã¾ã—ã‚‡ã†ï¼</p>
                        
                        <div class="row g-3">
                          <div class="col-6">
                            <button type="button" class="btn btn-outline-primary w-100" onclick="shareToTwitter()">
                              <i class="fab fa-twitter me-2"></i>X (Twitter)
                            </button>
                          </div>
                          <div class="col-6">
                            <button type="button" class="btn btn-outline-danger w-100" onclick="shareToInstagram()">
                              <i class="fab fa-instagram me-2"></i>Instagram
                            </button>
                          </div>
                          <div class="col-6">
                            <button type="button" class="btn btn-outline-success w-100" onclick="shareToLine()">
                              <i class="fab fa-line me-2"></i>LINE
                            </button>
                          </div>
                          <div class="col-6">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="copyShareText()">
                              <i class="fas fa-copy me-2"></i>ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼
                            </button>
                          </div>
                        </div>
                        
                        <div class="mt-4">
                          <label class="form-label">ã‚·ã‚§ã‚¢ãƒ†ã‚­ã‚¹ãƒˆ</label>
                          <textarea class="form-control" id="shareTextArea" rows="3" readonly>${shareText}

${shareUrl}</textarea>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                      </div>
                    </div>
                  </div>
                </div>
              `;

              // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤
              const existingModal = document.getElementById('snsShareModal');
              if (existingModal) {
                existingModal.remove();
              }

              // æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ 
              document.body.insertAdjacentHTML('beforeend', modalHTML);

              // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
              const modal = new bootstrap.Modal(document.getElementById('snsShareModal'));
              modal.show();
            }

            // X (Twitter)ã§ã‚·ã‚§ã‚¢
            function shareToTwitter() {
              const albumCount = document.querySelectorAll('.album-jacket').length;
              const text = `ç§ã®åç›¤ãƒªã‚¹ãƒˆï¼ˆ${albumCount}æšï¼‰ã‚’ä½œæˆã—ã¾ã—ãŸï¼ #TuneBox #åç›¤ãƒªã‚¹ãƒˆ #éŸ³æ¥½å¥½ãã¨ç¹‹ãŒã‚ŠãŸã„`;
              const url = window.location.href;
              const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
              window.open(twitterUrl, '_blank', 'width=600,height=400');
              
              // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
              const modal = bootstrap.Modal.getInstance(document.getElementById('snsShareModal'));
              if (modal) modal.hide();
            }

            // Instagramã§ã‚·ã‚§ã‚¢
            function shareToInstagram() {
              const albumCount = document.querySelectorAll('.album-jacket').length;
              const text = `ç§ã®åç›¤ãƒªã‚¹ãƒˆï¼ˆ${albumCount}æšï¼‰ã‚’ä½œæˆã—ã¾ã—ãŸï¼ #TuneBox #åç›¤ãƒªã‚¹ãƒˆ #éŸ³æ¥½å¥½ãã¨ç¹‹ãŒã‚ŠãŸã„`;
              const url = window.location.href;
              
              // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯Instagramã‚¢ãƒ—ãƒªã‚’é–‹ã
              if (navigator.userAgent.includes('Mobile')) {
                // Instagramã‚¢ãƒ—ãƒªã§é–‹ãï¼ˆãŸã ã—ã€ãƒ†ã‚­ã‚¹ãƒˆã®å…±æœ‰ã¯åˆ¶é™ãŒã‚ã‚‹ï¼‰
                window.open('instagram://app', '_blank');
                showMessage('Instagramã‚¢ãƒ—ãƒªãŒé–‹ãã¾ã—ãŸã€‚æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚', 'info');
    } else {
                // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
                navigator.clipboard.writeText(`${text}\n\n${url}`).then(() => {
                  showMessage('æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼Instagramã§æŠ•ç¨¿ã—ã¦ãã ã•ã„ã€‚', 'success');
                }).catch(() => {
                  showMessage('ãƒ†ã‚­ã‚¹ãƒˆã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                });
              }
              
              // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
              const modal = bootstrap.Modal.getInstance(document.getElementById('snsShareModal'));
              if (modal) modal.hide();
            }

            // LINEã§ã‚·ã‚§ã‚¢
            function shareToLine() {
              const albumCount = document.querySelectorAll('.album-jacket').length;
              const text = `ç§ã®åç›¤ãƒªã‚¹ãƒˆï¼ˆ${albumCount}æšï¼‰ã‚’ä½œæˆã—ã¾ã—ãŸï¼`;
              const url = window.location.href;
              const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text + '\n\n' + url)}`;
              window.open(lineUrl, '_blank');
              
              // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
              const modal = bootstrap.Modal.getInstance(document.getElementById('snsShareModal'));
              if (modal) modal.hide();
            }

            // ã‚·ã‚§ã‚¢ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
            function copyShareText() {
              const textArea = document.getElementById('shareTextArea');
              textArea.select();
              navigator.clipboard.writeText(textArea.value).then(() => {
                showMessage('ã‚·ã‚§ã‚¢ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼', 'success');
              }).catch(() => {
                showMessage('ãƒ†ã‚­ã‚¹ãƒˆã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
              });
              
              // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
              const modal = bootstrap.Modal.getInstance(document.getElementById('snsShareModal'));
              if (modal) modal.hide();
            }

// ä¸€æ‹¬å‰Šé™¤æ©Ÿèƒ½
function showBulkDeleteModal() {
  const modal = new bootstrap.Modal(document.getElementById('bulkDeleteModal'));
  modal.show();
}

function executeBulkDelete() {
  const albums = document.querySelectorAll('.album-jacket');
  const totalCount = albums.length;
  
  if (totalCount === 0) {
    showMessage('å‰Šé™¤ã™ã‚‹ã‚¢ãƒ«ãƒãƒ ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
    return;
  }
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('bulkDeleteModal'));
  modal.hide();
  
  showBulkDeleteProgress(totalCount);
  performBulkDelete(albums);
}

function showBulkDeleteProgress(totalCount) {
  const progressHtml = `
    <div class="bulk-delete-progress" id="bulkDeleteProgress">
      <div class="mb-3">
        <i class="fas fa-trash fa-2x text-danger"></i>
      </div>
      <h6 class="fw-bold mb-3">ã‚¢ãƒ«ãƒãƒ ã‚’ä¸€æ‹¬å‰Šé™¤ä¸­...</h6>
      <div class="progress mb-3" style="height: 10px;">
        <div class="progress-bar bg-danger" role="progressbar" style="width: 0%" id="deleteProgressBar"></div>
      </div>
      <p class="mb-0">
        <span id="deleteCount">0</span> / <span id="deleteTotalCount">${totalCount}</span> å®Œäº†
      </p>
      <small class="text-muted">ã™ã¹ã¦ã®ã‚¢ãƒ«ãƒãƒ ãŒä¸€æ°—ã«å‰Šé™¤ã•ã‚Œã¾ã™</small>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', progressHtml);
}

async function performBulkDelete(albums) {
  const totalCount = albums.length;
  
  if (totalCount === 0) {
    showMessage('å‰Šé™¤ã™ã‚‹ã‚¢ãƒ«ãƒãƒ ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
    return;
  }
  
  try {
    // ã™ã¹ã¦ã®ã‚¢ãƒ«ãƒãƒ ã‚’ä¸€æ°—ã«å‰Šé™¤
    const response = await fetch('/favorite_albums/bulk_destroy', {
        method: 'DELETE',
        headers: {
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').getAttribute('content'),
        'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      
    if (data.status === 'success') {
      // ã™ã¹ã¦ã®ã‚¢ãƒ«ãƒãƒ ã‚’ä¸€æ°—ã«éè¡¨ç¤ºã«ã™ã‚‹
      albums.forEach(album => {
        album.classList.add('deleting');
        setTimeout(() => {
          if (album.parentNode) {
            album.remove();
          }
        }, 300);
      });
      
      // ã‚¢ãƒ«ãƒãƒ ãƒªã‚¹ãƒˆã‚‚ä¸€æ°—ã«éè¡¨ç¤ºã«ã™ã‚‹
      const albumListItems = document.querySelectorAll('.album-list-item');
      albumListItems.forEach(item => {
        item.classList.add('deleting');
        setTimeout(() => {
          if (item.parentNode) {
            item.remove();
          }
        }, 300);
      });
      
      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’ä¸€æ°—ã«100%ã«ã™ã‚‹
      updateBulkDeleteProgress(totalCount, totalCount);
  
  setTimeout(() => {
    hideBulkDeleteProgress();
        showMessage(`${totalCount}æšã®ã‚¢ãƒ«ãƒãƒ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
    
        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ç©ºã®çŠ¶æ…‹ã‚’è¡¨ç¤º
    setTimeout(() => {
      window.location.reload();
  }, 1000);
      }, 500);
      
    } else {
      throw new Error(data.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
    
  } catch (error) {
    console.error('Bulk delete error:', error);
    hideBulkDeleteProgress();
    showMessage('ä¸€æ‹¬å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
  }
}

function updateBulkDeleteProgress(current, total) {
  const progressBar = document.getElementById('deleteProgressBar');
  const countElement = document.getElementById('deleteCount');
  
  if (progressBar && countElement) {
    const percentage = (current / total) * 100;
    progressBar.style.width = percentage + '%';
    countElement.textContent = current;
  }
}

function hideBulkDeleteProgress() {
  const progress = document.getElementById('bulkDeleteProgress');
  if (progress) {
    progress.style.opacity = '0';
    setTimeout(() => {
      if (progress.parentNode) {
        progress.parentNode.removeChild(progress);
      }
    }, 300);
  }
}

// ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
function saveCollection() {
  // å°†æ¥çš„ãªãƒã‚¤ãƒšãƒ¼ã‚¸æ©Ÿèƒ½ç”¨ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
  showMessage('ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒã‚¤ãƒšãƒ¼ã‚¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸï¼', 'success');
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
function showMessage(message, type) {
  const alertClass = type === 'error' ? 'alert-danger' : type === 'info' ? 'alert-info' : 'alert-success';
  const alertHtml = `
    <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
         style="top: 20px; right: 20px; z-index: 9999;" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', alertHtml);

  setTimeout(() => {
    const alert = document.querySelector('.alert');
    if (alert) alert.remove();
  }, 3000);
}
</script>