<%# ãŠæ°—ã«å…¥ã‚Šã‚¢ãƒ«ãƒãƒ ä¸€è¦§ãƒšãƒ¼ã‚¸ï¼ˆã‚²ã‚¹ãƒˆå¯¾å¿œï¼‰ %>

<div class="container-fluid px-0">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="fas fa-heart text-danger me-2"></i>
      <% if @is_guest %>
        ã‚ãªãŸã®åç›¤ãƒªã‚¹ãƒˆ <span class="badge bg-warning text-dark">ä½“é¨“ç‰ˆ</span>
      <% else %>
        ã‚ãªãŸã®åç›¤ãƒªã‚¹ãƒˆ
      <% end %>
    </h2>
    
    <div class="d-flex align-items-center gap-2">
      <span class="badge bg-primary fs-6"><%= @favorite_albums.count %> / <%= @is_guest ? 'âˆ' : '20' %> æš</span>
      
      <% if @is_guest %>
        <%= link_to albums_path, class: "btn btn-outline-primary" do %>
          <i class="fas fa-plus me-1"></i>è¿½åŠ 
        <% end %>
        <button class="btn btn-warning" onclick="saveToAccount()">
          <i class="fas fa-save me-1"></i>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ä¿å­˜
        </button>
      <% else %>
        <%= link_to albums_path, class: "btn btn-outline-primary" do %>
          <i class="fas fa-plus me-1"></i>è¿½åŠ 
        <% end %>
        <button class="btn btn-gradient" onclick="saveLayout()">
          <i class="fas fa-save me-1"></i>ä¿å­˜
        </button>
        <div class="dropdown">
          <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-share me-1"></i>å…±æœ‰
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="shareToTwitter()">
              <i class="fab fa-twitter me-2"></i>Xã«æŠ•ç¨¿
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="shareToInstagram()">
              <i class="fab fa-instagram me-2"></i>Instagram
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="shareToThreads()">
              <i class="fab fa-threads me-2"></i>Threads
            </a></li>
          </ul>
        </div>
      <% end %>
    </div>
  </div>

  <!-- ã‚²ã‚¹ãƒˆå‘ã‘ã®æ¡ˆå†… -->
  <% if @is_guest && @favorite_albums.empty? %>
    <div class="alert alert-info border-0 shadow-sm">
      <div class="d-flex align-items-center">
        <i class="fas fa-info-circle me-3" style="font-size: 1.5rem;"></i>
        <div>
          <h6 class="mb-1">ğŸµ ã¾ãšã¯æ°—è»½ã«è©¦ã—ã¦ã¿ã‚ˆã†ï¼</h6>
          <p class="mb-0 small">
            ãƒ­ã‚°ã‚¤ãƒ³ä¸è¦ã§åç›¤ãƒªã‚¹ãƒˆã‚’ä½œæˆã§ãã¾ã™ã€‚æ°—ã«å…¥ã£ãŸã‚‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ä¿å­˜ã—ã¾ã—ã‚‡ã†ã€‚
          </p>
        </div>
      </div>
    </div>
  <% end %>

  <!-- ã‚¢ãƒ«ãƒãƒ ãƒªã‚¹ãƒˆè¡¨ç¤º -->
  <% if @favorite_albums.empty? %>
    <div class="text-center py-5">
      <div class="mb-4">
        <i class="fas fa-heart-broken text-muted" style="font-size: 4rem;"></i>
      </div>
      <h4 class="text-muted mb-3">ã¾ã ã‚¢ãƒ«ãƒãƒ ãŒè¿½åŠ ã•ã‚Œã¦ã„ã¾ã›ã‚“</h4>
      <p class="text-muted mb-4">
        ãŠæ°—ã«å…¥ã‚Šã®ã‚¢ãƒ«ãƒãƒ ã‚’æ¤œç´¢ã—ã¦ã€ã‚ãªãŸã ã‘ã®åç›¤ãƒªã‚¹ãƒˆã‚’ä½œæˆã—ã¾ã—ã‚‡ã†ï¼
      </p>
      <%= link_to albums_path, class: "btn btn-gradient btn-lg" do %>
        <i class="fas fa-search me-2"></i>ã‚¢ãƒ«ãƒãƒ ã‚’æ¤œç´¢ã™ã‚‹
      <% end %>
    </div>
  <% else %>
    <!-- ã‚¢ãƒ«ãƒãƒ ã‚°ãƒªãƒƒãƒ‰ -->
    <div id="favorite-albums-grid" class="row g-3">
      <% if @is_guest %>
        <% @favorite_albums.each_with_index do |album, index| %>
          <div class="col-lg-2 col-md-3 col-sm-4 col-6 album-item" 
               data-position="<%= album['position'] %>" 
               data-id="<%= album['id'] %>">
            <%= render 'album_card', album: album, index: index, is_guest: true %>
          </div>
        <% end %>
      <% else %>
        <% @favorite_albums.each_with_index do |album, index| %>
          <div class="col-lg-2 col-md-3 col-sm-4 col-6 album-item" 
               data-position="<%= album.position %>" 
               data-id="<%= album.id %>">
            <%= render 'album_card', album: album, index: index, is_guest: false %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <!-- æ“ä½œèª¬æ˜ -->
  <% unless @favorite_albums.empty? %>
    <div class="mt-4 p-3 bg-light rounded">
      <h6 class="mb-2">
        <i class="fas fa-info-circle text-info me-2"></i>æ“ä½œæ–¹æ³•
      </h6>
      <ul class="mb-0 small text-muted">
        <li>ã‚¢ãƒ«ãƒãƒ ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦é †åºã‚’å¤‰æ›´ã§ãã¾ã™</li>
        <% if @is_guest %>
          <li>ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ä¿å­˜ã€ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãƒªã‚¹ãƒˆã‚’æ°¸ç¶šä¿å­˜</li>
        <% else %>
          <li>å¤‰æ›´ã—ãŸé †åºã¯ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ä¿å­˜ã—ã¦ãã ã•ã„</li>
          <li>ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ã§SNSã«æŠ•ç¨¿ã§ãã¾ã™</li>
        <% end %>
        <li>Ã—ãƒœã‚¿ãƒ³ã§ã‚¢ãƒ«ãƒãƒ ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã§ãã¾ã™</li>
      </ul>
    </div>
  <% end %>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  function saveLayout() {
    const items = document.querySelectorAll('.album-item');
    const positions = Array.from(items).map((item, index) => ({
      id: item.dataset.id,
      position: index + 1
    }));

    fetch('/favorite_albums/update_positions', {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').getAttribute('content')
      },
      body: JSON.stringify({ positions: positions })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showMessage('é †åºã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
      } else {
        showMessage('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    });
  }

  function saveToAccount() {
    fetch('/favorite_albums/save_to_account', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').getAttribute('content')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.redirect) {
        window.location.href = data.redirect;
      } else if (data.success) {
        showMessage(data.message, 'success');
        setTimeout(() => window.location.reload(), 1500);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    });
  }

  function shareToTwitter() {
    fetch('/favorite_albums/share', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').getAttribute('content')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.redirect) {
        window.location.href = data.redirect;
      } else {
        const text = `${data.title}\n${data.description}\n${data.url}`;
        const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
        window.open(url, '_blank');
      }
    });
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«é–¢æ•°ã‚’å…¬é–‹
  window.saveLayout = saveLayout;
  window.saveToAccount = saveToAccount;
  window.shareToTwitter = shareToTwitter;

  function showMessage(message, type) {
    const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
    const alertHtml = `
      <div class="alert ${alertClass} alert-dismissible fade show position-fixed"
           style="top: 20px; right: 20px; z-index: 9999;" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', alertHtml);

    setTimeout(() => {
      const alert = document.querySelector('.alert');
      if (alert) alert.remove();
    }, 3000);
  }
});
</script>