<div class="container mt-4">
  <h1> ã‚¢ãƒ«ãƒãƒ æ¤œç´¢</h1>

  <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
  <%= form_with url: albums_index_path, method: :get, local: true, class: "mb-4" do |form| %>
    <div class="input-group">
      <%= form.text_field :search,
          value: @search_query,
          placeholder: "ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚„ã‚¢ãƒ«ãƒãƒ åã§æ¤œç´¢...",
          class: "form-control form-control-lg" %>
      <%= form.submit "æ¤œç´¢", class: "btn btn-primary btn-lg" %>
    </div>
  <% end %>

  <!-- ãŠæ°—ã«å…¥ã‚Šæ•°è¡¨ç¤º -->
  <div class="alert alert-info d-flex justify-content-between align-items-center" id="favorite-status">
    <span>ç¾åœ¨ã®ãŠæ°—ã«å…¥ã‚Š: <span id="favorite-counter">èª­ã¿è¾¼ã¿ä¸­...</span> / 25</span>
    <%= link_to "ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹", favorite_albums_path, class: "btn btn-sm btn-outline-primary" %>
  </div>

  <!-- æ¤œç´¢çµæœã®çµ±è¨ˆ -->
  <% if @albums.any? %>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>æ¤œç´¢çµæœ</h3>
      <span class="badge bg-primary fs-6">
        å…¨ <%= @total_albums %> ä»¶ä¸­
        <%= (@page - 1) * 20 + 1 %>-<%= [@page * 20, @total_albums].min %> ä»¶ç›®
      </span>
    </div>

    <!-- ã‚¢ãƒ«ãƒãƒ ä¸€è¦§ -->
    <div class="row">
      <% @albums.each do |album| %>
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
          <div class="card h-100 hover-card position-relative">
            <% if album[:image_url] %>
              <img src="<%= album[:image_url] %>" class="card-img-top" alt="<%= album[:name] %>" style="height: 250px; object-fit: cover;">
            <% else %>
              <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 250px;">
                <i class="fas fa-music fa-3x text-muted"></i>
              </div>
            <% end %>

            <!-- ğŸ†• ä¿®æ­£ã•ã‚ŒãŸãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ -->
            <div class="position-absolute top-0 end-0 p-2" style="z-index: 10;">
             <button class="btn btn-outline-success btn-sm add-btn"
               data-spotify-id="<%= album[:spotify_id] %>"
               data-name="<%= album[:name] %>"
               data-artist="<%= album[:artist] %>"
               data-image-url="<%= album[:image_url] %>"
               data-external-url="<%= album[:external_url] %>"
               data-release-date="<%= album[:release_date] %>"
               data-total-tracks="<%= album[:total_tracks] %>"
               onclick="addToFavorites(this)"
               style="border-radius: 8px; width: 40px; height: 40px; backdrop-filter: blur(5px); background: rgba(255,255,255,0.9); position: relative; z-index: 11;">
              <i class="fas fa-plus"></i>
             </button>
            </div>

            <div class="card-body d-flex flex-column">
              <h6 class="card-title"><%= album[:name] %></h6>
              <p class="card-text small text-muted mb-2"><%= album[:artist] %></p>
              <p class="card-text small text-muted mb-2">
                <i class="fas fa-calendar me-1"></i><%= album[:release_date] %>
              </p>
              <p class="card-text small text-muted mb-3">
                <i class="fas fa-music me-1"></i><%= album[:total_tracks] %> æ›²
              </p>
              <div class="mt-auto">
                <a href="<%= album[:external_url] %>" target="_blank" class="btn btn-success btn-sm w-100">
                  <i class="fab fa-spotify me-1"></i>Spotifyã§è´ã
                </a>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
    <% if @total_pages > 1 %>
      <nav aria-label="æ¤œç´¢çµæœãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³" class="mt-5">
        <ul class="pagination justify-content-center">
          <!-- å‰ã®ãƒšãƒ¼ã‚¸ -->
          <% if @page > 1 %>
            <li class="page-item">
              <%= link_to albums_index_path(search: @search_query, page: @page - 1), class: "page-link" do %>
                <i class="fas fa-chevron-left"></i> å‰ã¸
              <% end %>
            </li>
          <% else %>
            <li class="page-item disabled">
              <span class="page-link"><i class="fas fa-chevron-left"></i> å‰ã¸</span>
            </li>
          <% end %>

          <!-- ãƒšãƒ¼ã‚¸ç•ªå· -->
          <%
            start_page = [@page - 2, 1].max
            end_page = [start_page + 4, @total_pages].min
            start_page = [end_page - 4, 1].max if end_page - start_page < 4
          %>

          <% if start_page > 1 %>
            <li class="page-item">
              <%= link_to "1", albums_index_path(search: @search_query, page: 1), class: "page-link" %>
            </li>
            <% if start_page > 2 %>
              <li class="page-item disabled"><span class="page-link">...</span></li>
            <% end %>
          <% end %>

          <% (start_page..end_page).each do |page_num| %>
            <li class="page-item <%= 'active' if page_num == @page %>">
              <%= link_to page_num, albums_index_path(search: @search_query, page: page_num), class: "page-link" %>
            </li>
          <% end %>

          <% if end_page < @total_pages %>
            <% if end_page < @total_pages - 1 %>
              <li class="page-item disabled"><span class="page-link">...</span></li>
            <% end %>
            <li class="page-item">
              <%= link_to @total_pages, albums_index_path(search: @search_query, page: @total_pages), class: "page-link" %>
            </li>
          <% end %>

          <!-- æ¬¡ã®ãƒšãƒ¼ã‚¸ -->
          <% if @page < @total_pages %>
            <li class="page-item">
              <%= link_to albums_index_path(search: @search_query, page: @page + 1), class: "page-link" do %>
                æ¬¡ã¸ <i class="fas fa-chevron-right"></i>
              <% end %>
            </li>
          <% else %>
            <li class="page-item disabled">
              <span class="page-link">æ¬¡ã¸ <i class="fas fa-chevron-right"></i></span>
            </li>
          <% end %>
        </ul>
      </nav>

      <!-- ãƒšãƒ¼ã‚¸æƒ…å ± -->
      <div class="text-center text-muted mt-3">
        <small>
          ãƒšãƒ¼ã‚¸ <%= @page %> / <%= @total_pages %>
          (å…¨ <%= @total_albums %> ä»¶ã®ã‚¢ãƒ«ãƒãƒ )
        </small>
      </div>
    <% end %>

  <% elsif @search_query.present? %>
    <div class="alert alert-warning">
      <i class="fas fa-search me-2"></i>
      ã€Œ<%= @search_query %>ã€ã®æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
    </div>
  <% else %>
    <div class="text-center text-muted mt-5">
      <i class="fas fa-search fa-3x mb-3"></i>
      <p>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚„ã‚¢ãƒ«ãƒãƒ åã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</p>
    </div>
  <% end %>
</div>

<script>
// ğŸ†• æ¤œç´¢ãƒšãƒ¼ã‚¸ç”¨ã®JavaScript
let currentFavoriteCount = 0;

document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ”§ Initializing search page...');
  
  // ãŠæ°—ã«å…¥ã‚Šæ•°ã‚’èª­ã¿è¾¼ã¿
  loadFavoriteCount();
  
  // æ—¢å­˜ã®ãŠæ°—ã«å…¥ã‚Šã‚’ç¢ºèª
  checkExistingFavorites();
});

// ğŸ†• ãŠæ°—ã«å…¥ã‚Šæ•°ã‚’èª­ã¿è¾¼ã‚€
function loadFavoriteCount() {
  console.log('ğŸ“Š Loading favorite count...');
  
  fetch('/favorite_albums.json', {
    headers: {
      'Accept': 'application/json',
      'X-CSRF-Token': getCSRFToken()
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    currentFavoriteCount = data.length;
    updateFavoriteCounter();
    console.log('âœ… Current favorite count:', currentFavoriteCount);
  })
  .catch(error => {
    console.error('âŒ Error loading favorites:', error);
    document.getElementById('favorite-counter').textContent = 'ã‚¨ãƒ©ãƒ¼';
  });
}

// ğŸ†• ãŠæ°—ã«å…¥ã‚Šæ•°è¡¨ç¤ºã‚’æ›´æ–°
function updateFavoriteCounter() {
  const counter = document.getElementById('favorite-counter');
  if (counter) {
    counter.textContent = currentFavoriteCount;
    
    // ä¸Šé™ã«è¿‘ã¥ã„ãŸæ™‚ã®è­¦å‘Šè¡¨ç¤º
    const status = document.getElementById('favorite-status');
    if (currentFavoriteCount >= 25) {
      status.classList.remove('alert-info');
      status.classList.add('alert-danger');
    } else if (currentFavoriteCount >= 20) {
      status.classList.remove('alert-info');
      status.classList.add('alert-warning');
    } else {
      status.classList.remove('alert-warning', 'alert-danger');
      status.classList.add('alert-info');
    }
  }
}

// ğŸ†• æ—¢å­˜ã®ãŠæ°—ã«å…¥ã‚Šã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
function checkExistingFavorites() {
  fetch('/favorite_albums.json', {
    headers: {
      'Accept': 'application/json',
      'X-CSRF-Token': getCSRFToken()
    }
  })
  .then(response => response.json())
  .then(favorites => {
    const favoriteIds = new Set(favorites.map(fav => fav.spotify_id));
    
    // å„ã‚¢ãƒ«ãƒãƒ ã®ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.add-btn').forEach(btn => {
      const spotifyId = btn.dataset.spotifyId;
      if (favoriteIds.has(spotifyId)) {
        updateButtonToRemove(btn);
      }
    });
  })
  .catch(error => {
    console.error('âŒ Error checking favorites:', error);
  });
}

// ğŸ†• ãŠæ°—ã«å…¥ã‚Šè¿½åŠ /å‰Šé™¤ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
function addToFavorites(button) {
  console.log('ğŸ¯ Add to favorites clicked');
  
  const isCurrentlyFavorite = button.classList.contains('btn-danger');
  const spotifyId = button.dataset.spotifyId;
  
  if (isCurrentlyFavorite) {
    // å‰Šé™¤å‡¦ç†
    removeFavorite(button, spotifyId);
  } else {
    // è¿½åŠ å‡¦ç†
    addFavorite(button);
  }
}

// ğŸ†• ãŠæ°—ã«å…¥ã‚Šè¿½åŠ å‡¦ç†
function addFavorite(button) {
  // ä¸Šé™ãƒã‚§ãƒƒã‚¯
  if (currentFavoriteCount >= 25) {
    showMessage('ãŠæ°—ã«å…¥ã‚Šã¯æœ€å¤§25å€‹ã¾ã§ã§ã™', 'error');
    return;
  }
  
  // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
  button.disabled = true;
  const originalContent = button.innerHTML;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  
  const albumData = {
    spotify_id: button.dataset.spotifyId,
    name: button.dataset.name,
    artist: button.dataset.artist,
    image_url: button.dataset.imageUrl,
    external_url: button.dataset.externalUrl,
    release_date: button.dataset.releaseDate,
    total_tracks: parseInt(button.dataset.totalTracks)
  };
  
  console.log('ğŸ“¤ Adding album to favorites:', albumData);
  
  fetch('/favorite_albums/toggle', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': getCSRFToken(),
      'Accept': 'application/json'
    },
    body: JSON.stringify({
      favorite_album: albumData
    })
  })
  .then(response => {
    console.log('ğŸ“¥ Response status:', response.status);
    
    if (!response.ok) {
      return response.text().then(text => {
        console.error('âŒ Response text:', text);
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      });
    }
    return response.json();
  })
  .then(data => {
    console.log('âœ… Add response:', data);
    
    button.disabled = false;
    
    if (data.status === 'added') {
      currentFavoriteCount = data.current_count;
      updateFavoriteCounter();
      updateButtonToRemove(button);
      showMessage(`ã€Œ${albumData.name}ã€ã‚’ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ ã—ã¾ã—ãŸï¼`, 'success');
    } else if (data.status === 'guest_mode') {
      button.innerHTML = originalContent;
      showMessage(data.message, 'info');
    } else if (data.status === 'error') {
      button.innerHTML = originalContent;
      showMessage(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
  })
  .catch(error => {
    console.error('âŒ Add error:', error);
    button.disabled = false;
    button.innerHTML = originalContent;
    showMessage('è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
  });
}

// ğŸ†• ãŠæ°—ã«å…¥ã‚Šå‰Šé™¤å‡¦ç†
function removeFavorite(button, spotifyId) {
  // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
  button.disabled = true;
  const originalContent = button.innerHTML;
  button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
  
  console.log('ğŸ—‘ï¸ Removing album from favorites:', spotifyId);
  
  fetch(`/favorite_albums/${spotifyId}`, {
    method: 'DELETE',
    headers: {
      'X-CSRF-Token': getCSRFToken(),
      'Accept': 'application/json'
    }
  })
  .then(response => {
    console.log('ğŸ“¥ Delete response status:', response.status);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('âœ… Remove response:', data);
    
    button.disabled = false;
    
    if (data.status === 'removed') {
      currentFavoriteCount = Math.max(0, currentFavoriteCount - 1);
      updateFavoriteCounter();
      updateButtonToAdd(button);
      showMessage('ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    }
  })
  .catch(error => {
    console.error('âŒ Remove error:', error);
    button.disabled = false;
    button.innerHTML = originalContent;
    showMessage('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
  });
}

// ğŸ†• ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤çŠ¶æ…‹ã«æ›´æ–°
function updateButtonToRemove(button) {
  button.classList.remove('btn-outline-success');
  button.classList.add('btn-danger');
  button.innerHTML = '<i class="fas fa-check"></i>';
  button.title = 'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å‰Šé™¤';
}

// ğŸ†• ãƒœã‚¿ãƒ³ã‚’è¿½åŠ çŠ¶æ…‹ã«æ›´æ–°
function updateButtonToAdd(button) {
  button.classList.remove('btn-danger');
  button.classList.add('btn-outline-success');
  button.innerHTML = '<i class="fas fa-plus"></i>';
  button.title = 'ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ ';
}

// ğŸ†• CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
function getCSRFToken() {
  const token = document.querySelector('[name="csrf-token"]')?.getAttribute('content') || 
               document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  
  if (!token) {
    console.error('âŒ CSRF token not found');
  }
  
  return token;
}

// ğŸ†• ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ©Ÿèƒ½
function showMessage(message, type = 'info') {
  console.log(`ğŸ’¬ Message (${type}):`, message);
  
  // æ—¢å­˜ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‰Šé™¤
  const existingAlert = document.querySelector('.custom-alert');
  if (existingAlert) {
    existingAlert.remove();
  }
  
  const alertClass = type === 'error' ? 'alert-danger' : 
                    type === 'success' ? 'alert-success' : 'alert-info';
  
  const alertHtml = `
    <div class="alert ${alertClass} alert-dismissible fade show position-fixed custom-alert"
         style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
        <div class="d-flex align-items-center">
          <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
          <span>${message}</span>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', alertHtml);

  // è‡ªå‹•ã§æ¶ˆå»
  setTimeout(() => {
    const alert = document.querySelector('.custom-alert');
    if (alert) {
      alert.classList.remove('show');
      setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, 150);
    }
  }, 4000);
}


</script>

<style>
/* ğŸ†• æ¤œç´¢ãƒšãƒ¼ã‚¸ç”¨ã®è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
.hover-card {
  transition: all 0.3s ease;
  border: 1px solid #dee2e6;
}

.hover-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  border-color: #667eea;
}

.add-btn {
  transition: all 0.3s ease;
  border: 2px solid currentColor !important;
}

.add-btn:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.add-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none !important;
}

.custom-alert {
  animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹åˆ¥ã‚¹ã‚¿ã‚¤ãƒ« */
.btn-outline-success.add-btn {
  color: #198754;
  border-color: #198754;
  background: rgba(255,255,255,0.9);
}

.btn-outline-success.add-btn:hover {
  color: white;
  background: #198754;
  border-color: #198754;
}

.btn-danger.add-btn {
  color: white;
  background: #dc3545;
  border-color: #dc3545;
}

.btn-danger.add-btn:hover {
  background: #c82333;
  border-color: #bd2130;
}

/* ãŠæ°—ã«å…¥ã‚Šæ•°ã®è­¦å‘Šè¡¨ç¤º */
#favorite-status.alert-warning {
  border-color: #ffc107;
  background-color: #fff3cd;
  color: #856404;
}

#favorite-status.alert-danger {
  border-color: #dc3545;
  background-color: #f8d7da;
  color: #721c24;
}
</style>