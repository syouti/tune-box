<div class="container mt-4">
  <h1>ğŸµ ã‚¢ãƒ«ãƒãƒ æ¤œç´¢</h1>

  <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
  <%= form_with url: albums_index_path, method: :get, local: true, class: "mb-4" do |form| %>
    <div class="input-group">
      <%= form.text_field :search,
          value: @search_query,
          placeholder: "ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚„ã‚¢ãƒ«ãƒãƒ åã§æ¤œç´¢...",
          class: "form-control form-control-lg" %>
      <%= form.submit "æ¤œç´¢", class: "btn btn-primary btn-lg" %>
    </div>
  <% end %>

  <!-- ãŠæ°—ã«å…¥ã‚Šæ•°è¡¨ç¤º -->
  <div class="alert alert-info d-flex justify-content-between align-items-center" id="favorite-status">
    <span>ç¾åœ¨ã®ãŠæ°—ã«å…¥ã‚Š: <span id="favorite-counter">èª­ã¿è¾¼ã¿ä¸­...</span> / 25</span>
    <%= link_to "ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹", favorite_albums_path, class: "btn btn-sm btn-outline-primary" %>
  </div>

  <!-- æ¤œç´¢çµæœã®çµ±è¨ˆ -->
  <% if @albums.any? %>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>æ¤œç´¢çµæœ</h3>
      <span class="badge bg-primary fs-6">
        å…¨ <%= @total_albums %> ä»¶ä¸­
        <%= (@page - 1) * 20 + 1 %>-<%= [@page * 20, @total_albums].min %> ä»¶ç›®
      </span>
    </div>

    <!-- ã‚¢ãƒ«ãƒãƒ ä¸€è¦§ -->
    <div class="row">
      <% @albums.each do |album| %>
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
          <div class="card h-100 hover-card position-relative">
            <% if album[:image_url] %>
              <img src="<%= album[:image_url] %>" class="card-img-top" alt="<%= album[:name] %>" style="height: 250px; object-fit: cover;">
            <% else %>
              <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 250px;">
                <i class="fas fa-music fa-3x text-muted"></i>
              </div>
            <% end %>

            <!-- ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ï¼ˆç”»åƒã®ä¸Šã«é‡ã­ã¦è¡¨ç¤ºï¼‰ -->
            <div class="position-absolute top-0 end-0 p-2" style="z-index: 10;">
             <button class="btn btn-outline-success btn-sm add-btn"
               data-spotify-id="<%= album[:spotify_id] %>"
               data-name="<%= album[:name] %>"
               data-artist="<%= album[:artist] %>"
               data-image-url="<%= album[:image_url] %>"
               data-external-url="<%= album[:external_url] %>"
               data-release-date="<%= album[:release_date] %>"
               data-total-tracks="<%= album[:total_tracks] %>"
               style="border-radius: 8px; width: 40px; height: 40px; backdrop-filter: blur(5px); background: rgba(255,255,255,0.9); position: relative; z-index: 11;">
              <i class="fas fa-plus"></i>
             </button>
            </div>

            <div class="card-body d-flex flex-column">
              <h6 class="card-title"><%= album[:name] %></h6>
              <p class="card-text small text-muted mb-2"><%= album[:artist] %></p>
              <p class="card-text small text-muted mb-2">
                <i class="fas fa-calendar me-1"></i><%= album[:release_date] %>
              </p>
              <p class="card-text small text-muted mb-3">
                <i class="fas fa-music me-1"></i><%= album[:total_tracks] %> æ›²
              </p>
              <div class="mt-auto">
                <a href="<%= album[:external_url] %>" target="_blank" class="btn btn-success btn-sm w-100">
                  <i class="fab fa-spotify me-1"></i>Spotifyã§è´ã
                </a>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
    <% if @total_pages > 1 %>
      <nav aria-label="æ¤œç´¢çµæœãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³" class="mt-5">
        <ul class="pagination justify-content-center">
          <!-- å‰ã®ãƒšãƒ¼ã‚¸ -->
          <% if @page > 1 %>
            <li class="page-item">
              <%= link_to albums_index_path(search: @search_query, page: @page - 1), class: "page-link" do %>
                <i class="fas fa-chevron-left"></i> å‰ã¸
              <% end %>
            </li>
          <% else %>
            <li class="page-item disabled">
              <span class="page-link"><i class="fas fa-chevron-left"></i> å‰ã¸</span>
            </li>
          <% end %>

          <!-- ãƒšãƒ¼ã‚¸ç•ªå· -->
          <%
            start_page = [@page - 2, 1].max
            end_page = [start_page + 4, @total_pages].min
            start_page = [end_page - 4, 1].max if end_page - start_page < 4
          %>

          <% if start_page > 1 %>
            <li class="page-item">
              <%= link_to "1", albums_index_path(search: @search_query, page: 1), class: "page-link" %>
            </li>
            <% if start_page > 2 %>
              <li class="page-item disabled"><span class="page-link">...</span></li>
            <% end %>
          <% end %>

          <% (start_page..end_page).each do |page_num| %>
            <li class="page-item <%= 'active' if page_num == @page %>">
              <%= link_to page_num, albums_index_path(search: @search_query, page: page_num), class: "page-link" %>
            </li>
          <% end %>

          <% if end_page < @total_pages %>
            <% if end_page < @total_pages - 1 %>
              <li class="page-item disabled"><span class="page-link">...</span></li>
            <% end %>
            <li class="page-item">
              <%= link_to @total_pages, albums_index_path(search: @search_query, page: @total_pages), class: "page-link" %>
            </li>
          <% end %>

          <!-- æ¬¡ã®ãƒšãƒ¼ã‚¸ -->
          <% if @page < @total_pages %>
            <li class="page-item">
              <%= link_to albums_index_path(search: @search_query, page: @page + 1), class: "page-link" do %>
                æ¬¡ã¸ <i class="fas fa-chevron-right"></i>
              <% end %>
            </li>
          <% else %>
            <li class="page-item disabled">
              <span class="page-link">æ¬¡ã¸ <i class="fas fa-chevron-right"></i></span>
            </li>
          <% end %>
        </ul>
      </nav>

      <!-- ãƒšãƒ¼ã‚¸æƒ…å ± -->
      <div class="text-center text-muted mt-3">
        <small>
          ãƒšãƒ¼ã‚¸ <%= @page %> / <%= @total_pages %>
          (å…¨ <%= @total_albums %> ä»¶ã®ã‚¢ãƒ«ãƒãƒ )
        </small>
      </div>
    <% end %>

  <% elsif @search_query.present? %>
    <div class="alert alert-warning">
      <i class="fas fa-search me-2"></i>
      ã€Œ<%= @search_query %>ã€ã®æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
    </div>
  <% else %>
    <div class="text-center text-muted mt-5">
      <i class="fas fa-search fa-3x mb-3"></i>
      <p>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚„ã‚¢ãƒ«ãƒãƒ åã‚’å…¥åŠ›ã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</p>
    </div>
  <% end %>
</div>

<script>
let clickHandlerAttached = false;

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded'); // ãƒ‡ãƒãƒƒã‚°ç”¨
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç¾åœ¨ã®ãŠæ°—ã«å…¥ã‚Šæ•°ã‚’å–å¾—
    fetchCurrentFavoriteCount();
    
    if (clickHandlerAttached) {
        console.log('Click handler already attached, skipping');
        return;
    }
    
    // add-btnã‚¯ãƒ©ã‚¹ã®ãƒœã‚¿ãƒ³ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    document.addEventListener('click', function(e) {
        if (e.target.closest('.add-btn')) {
            e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã‚’åœæ­¢
            e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢
            
            const btn = e.target.closest('.add-btn');
            console.log('Button clicked:', btn); // ãƒ‡ãƒãƒƒã‚°ç”¨
            console.log('Button disabled:', btn.disabled); // ãƒ‡ãƒãƒƒã‚°ç”¨
            
            if (btn.disabled) {
                console.log('Button is disabled, ignoring click');
                return;
            }
            
            handleAddButtonClick(btn);
        }
    });
    
    clickHandlerAttached = true;
    console.log('Click handler attached successfully');
});

function handleAddButtonClick(btn) {
    console.log('Handling button click for:', btn.dataset.name);
    
    // æ—¢ã«è¿½åŠ æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã§åˆ¤æ–­ï¼‰
    const isAdded = btn.classList.contains('added');
    
    if (!isAdded) {
        // è¿½åŠ å‰ã«ä¸Šé™ãƒã‚§ãƒƒã‚¯
        const currentCount = getCurrentFavoriteCount();
        if (currentCount >= 25) {
            console.log('Limit reached:', currentCount);
            showMessage('ãŠæ°—ã«å…¥ã‚Šã¯æœ€å¤§25å€‹ã¾ã§ã§ã™', 'error');
            return;
        }
    }
    
    // ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const albumData = {
        spotify_id: btn.dataset.spotifyId,
        name: btn.dataset.name,
        artist: btn.dataset.artist,
        image_url: btn.dataset.imageUrl,
        external_url: btn.dataset.externalUrl,
        release_date: btn.dataset.releaseDate,
        total_tracks: btn.dataset.totalTracks
    };
    
    console.log('Album data:', albumData); // ãƒ‡ãƒãƒƒã‚°ç”¨
    
    // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
    fetch('/favorite_albums/toggle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({
            favorite_album: albumData
        })
    })
    .then(response => {
        console.log('Response status:', response.status); // ãƒ‡ãƒãƒƒã‚°ç”¨
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
        
        // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        btn.disabled = false;
        
        if (data.status === 'added') {
            updateButtonState(btn, true);
            console.log('Album added successfully');
            updateFavoriteCount(data.current_count || getCurrentFavoriteCount() + 1);
        } else if (data.status === 'removed') {
            updateButtonState(btn, false);
            console.log('Album removed successfully');
            updateFavoriteCount(data.current_count || getCurrentFavoriteCount() - 1);
        } else if (data.status === 'error') {
            updateButtonState(btn, false);
            console.log('Server error:', data.message);
            showMessage(data.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        btn.disabled = false;
        updateButtonState(btn, false);
        showMessage('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    });
}

let currentFavoriteCount = 0; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ç®¡ç†

// ãŠæ°—ã«å…¥ã‚Šæ•°ã‚’ç®¡ç†ã™ã‚‹é–¢æ•°
function getCurrentFavoriteCount() {
    return currentFavoriteCount;
}

function updateFavoriteCount(count) {
    currentFavoriteCount = count;
    const counter = document.getElementById('favorite-counter');
    if (counter) {
        counter.textContent = count;
    } else {
        console.log('favorite-counter element not found, count stored in memory:', count);
    }
    checkFavoriteLimit();
}

function checkFavoriteLimit() {
    const count = getCurrentFavoriteCount();
    const addButtons = document.querySelectorAll('.add-btn');
    
    addButtons.forEach(btn => {
        const isAdded = btn.classList.contains('added');
        if (!isAdded && count >= 25) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.title = 'ãŠæ°—ã«å…¥ã‚Šã¯æœ€å¤§25å€‹ã¾ã§ã§ã™';
        } else if (!isAdded) {
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.title = '';
        }
    });
}

function updateButtonState(btn, isAdded) {
    if (isAdded) {
        btn.style.background = '#28a745';
        btn.style.borderColor = '#28a745';
        btn.style.color = 'white';
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.classList.add('added');
    } else {
        btn.style.background = 'rgba(255,255,255,0.9)';
        btn.style.borderColor = '#28a745';
        btn.style.color = '#28a745';
        btn.innerHTML = '<i class="fas fa-plus"></i>';
        btn.classList.remove('added');
    }
}

// ç¾åœ¨ã®ãŠæ°—ã«å…¥ã‚Šæ•°ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function fetchCurrentFavoriteCount() {
    fetch('/favorite_albums.json')
        .then(response => response.json())
        .then(data => {
            const count = data.length || 0;
            console.log('Fetched favorite count:', count);
            updateFavoriteCount(count);
        })
        .catch(error => {
            console.log('ãŠæ°—ã«å…¥ã‚Šæ•°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯0ã§åˆæœŸåŒ–
            updateFavoriteCount(0);
        });
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
function showMessage(message, type) {
    // æ—¢å­˜ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‰Šé™¤
    const existingAlerts = document.querySelectorAll('.custom-alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'info' ? 'alert-info' : 'alert-success';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed custom-alert"
             style="top: 20px; right: 20px; z-index: 1050; max-width: 300px; pointer-events: none;" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" style="pointer-events: auto;"></button>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', alertHtml);

    setTimeout(() => {
        const alert = document.querySelector('.custom-alert');
        if (alert) alert.remove();
    }, 3000);
}
</script>